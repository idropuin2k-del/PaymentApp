name: Build iOS App

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Select Xcode Version
      run: sudo xcode-select -s /Applications/Xcode_15.4.app/Contents/Developer

    - name: Show Xcode and SDK Info
      run: |
        xcodebuild -version
        xcodebuild -showsdks

    - name: List Available Simulators
      run: xcrun simctl list devices available

    - name: Build Project
      run: |
        xcodebuild clean build \
          -project PaymentApp.xcodeproj \
          -scheme PaymentApp \
          -configuration Release \
          -sdk iphoneos \
          -allowProvisioningUpdates \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          DEVELOPMENT_TEAM="" \
          PROVISIONING_PROFILE_SPECIFIER=""

    - name: Create Archive
      run: |
        xcodebuild archive \
          -project PaymentApp.xcodeproj \
          -scheme PaymentApp \
          -configuration Release \
          -sdk iphoneos \
          -archivePath ./PaymentApp.xcarchive \
          -allowProvisioningUpdates \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          DEVELOPMENT_TEAM="" \
          PROVISIONING_PROFILE_SPECIFIER=""

    - name: Create IPA Package
      run: |
        # Create Payload directory
        mkdir -p Payload

        # Copy the app to Payload
        cp -r ./PaymentApp.xcarchive/Products/Applications/PaymentApp.app Payload/

        # Create the IPA
        zip -r PaymentApp.ipa Payload/

        # Verify the IPA was created
        ls -la PaymentApp.ipa
        file PaymentApp.ipa

    - name: Upload IPA Artifact
      uses: actions/upload-artifact@v4
      with:
        name: PaymentApp-IPA
        path: PaymentApp.ipa
        retention-days: 30

    - name: Create Release
      if: github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}
        name: PaymentApp v${{ github.run_number }}
        body: |
          ðŸ“± **PaymentApp - Ready for Sideloading!**

          **ðŸš€ Features:**
          - ðŸ’° Balance display with beautiful gradient UI
          - âž• Add cash (custom amounts + quick buttons: $10, $20, $50, $100, $200, $500)
          - âž– Cash out with balance validation
          - ðŸ“Š Complete transaction history
          - ðŸŽ® Demo data included (starts with $250 balance)

          **ðŸ“± Sideloading Instructions:**

          1. **Download** `PaymentApp.ipa` from the assets below
          2. **Install Sideloadly** from https://sideloadly.io
          3. **Connect your iPhone/iPad** via USB to your computer
          4. **Open Sideloadly** and drag the .ipa file into it
          5. **Enter your Apple ID** credentials
          6. **Click "Start"** and wait for installation

          **âœ… What You'll Get:**
          - Complete payment app demo on your iOS device
          - All features working locally (no internet required)
          - Safe to use (no real money, just demo data)

          **ðŸ“‹ System Requirements:**
          - iOS 16.0 or later
          - Any iPhone or iPad
          - Free Apple ID for sideloading

        files: PaymentApp.ipa
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload Build Logs on Failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          ~/Library/Developer/Xcode/DerivedData/**/Build/**/*.log
          /tmp/xcodebuild.log
        retention-days: 7